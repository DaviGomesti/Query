-------SQL BÁSICO

--Tipos de dados: https://docs.microsoft.com/pt-br/sql/t-sql/data-types/data-types-transact-sql?view=sql-server-ver15
    --Mostrar que pode ser lido em PT/EN (canto superior direito) e que pode mudar a versão do SQL Server ao qual a documentação se refere (canto superior esquerdo)


CREATE TABLE FABRICANTES(
    ID_FABRICANTE INT NOT NULL,
    NOME VARCHAR(255) NOT NULL,
    CNPJ CHAR(14) NOT NULL
);
GO

--EXPLICAR IDENTITY
DROP TABLE FABRICANTES;
GO

--EXPLICAR IDENTITY
--https://docs.microsoft.com/pt-br/sql/t-sql/statements/create-table-transact-sql-identity-property?view=sql-server-2017

CREATE TABLE FABRICANTES(
    ID_FABRICANTE INT NOT NULL IDENTITY(1,1),
    NOME VARCHAR(255) NOT NULL,
    CNPJ CHAR(14) NOT NULL
);
GO

CREATE TABLE PRODUTOS(
    ID_PRODUTO INT NOT NULL IDENTITY(1,1),
    NOME VARCHAR(255) NOT NULL,
    FK_FABRICANTE INT NOT NULL
);
GO

ALTER TABLE PRODUTOS
ADD UNIDADE_MEDIDA VARCHAR(32) NULL
GO

ALTER TABLE PRODUTOS
DROP COLUMN UNIDADE_MEDIDA;
GO

ALTER TABLE PRODUTOS
ADD UNIDADE_MEDIDA VARCHAR(32) NULL;
GO

ALTER TABLE PRODUTOS
ALTER COLUMN UNIDADE_MEDIDA VARCHAR(64) NULL;
GO

ALTER TABLE PRODUTOS
ALTER COLUMN UNIDADE_MEDIDA VARCHAR(64) NOT NULL;
GO

ALTER TABLE PRODUTOS
ALTER COLUMN UNIDADE_MEDIDA VARCHAR(32) NULL;
GO

--MOSTRAR (USANDO ALT+F1) QUE A ORDEM DAS COLUNAS NÃO PODE SER INVERTIDA (NEM IMPORTA). A ÚNICA ALTERNATIVA É RECRIAR A TABELA (NÃO FAZ SENTIDO)
--EXPLICAR OS RISCOS DE ALTERAR A ORDEM DAS COLUNAS (APLICATIVOS QUE DEPENDAM DA ORDEM ATUAL EM UM INSERT SELECT NÃO EXPLÍCITO, POR EXEMPLO)
--https://docs.microsoft.com/pt-br/sql/relational-databases/tables/change-column-order-in-a-table?view=sql-server-2017

DROP TABLE PRODUTOS;
GO

CREATE TABLE PRODUTOS(
    ID_PRODUTO INT NOT NULL IDENTITY(1,1),
    NOME VARCHAR(255) NOT NULL,
    UNIDADE_MEDIDA VARCHAR(32) NULL,
    FK_FABRICANTE INT NOT NULL
);
GO

--EXPLICAR PRIMARY KEY
ALTER TABLE PRODUTOS
ADD CONSTRAINT PK_PRODUTOS PRIMARY KEY(ID_PRODUTO);
GO

--EXPLICAR FOREIGN KEY
--VAI DAR ERRO PORQUE FABRICANTES NÃO TEM PK NO CAMPO EM QUESTÃO - ID_FABRICANTE
ALTER TABLE PRODUTOS
ADD CONSTRAINT FK_PRODUTOS_FABRICANTES FOREIGN KEY(FK_FABRICANTE) REFERENCES FABRICANTES(ID_FABRICANTE);
GO

ALTER TABLE FABRICANTES ADD CONSTRAINT PK_FABRICANTES PRIMARY KEY(ID_FABRICANTE);
GO

ALTER TABLE PRODUTOS
ADD CONSTRAINT FK_PRODUTOS_FABRICANTES FOREIGN KEY(FK_FABRICANTE) REFERENCES FABRICANTES(ID_FABRICANTE);
GO

CREATE TABLE ESTOQUES(
    ID_ESTOQUE INT NOT NULL IDENTITY(1,1),
    FK_PRODUTO INT NOT NULL,
    VALOR NUMERIC(6,2) NOT NULL,
    QUANTIDADE SMALLINT NOT NULL,

    CONSTRAINT PK_ESTOQUES PRIMARY KEY(ID_ESTOQUE),

    CONSTRAINT CHK_ESTOQUES_VALOR CHECK(VALOR > 0),

	CONSTRAINT FK_ESTOQUES_PRODUTOS FOREIGN KEY(FK_PRODUTO) REFERENCES PRODUTOS(ID_PRODUTO)

    
);
GO

CREATE TABLE LOJAS(
    ID_LOJA INT NOT NULL IDENTITY(1,1),
    NOME VARCHAR(255) NOT NULL,
    LOGRADOURO VARCHAR(255) NOT NULL,
    NUM_LOGRADOURO VARCHAR(16) NULL,
    CEP CHAR(8) NOT NULL,
    BAIRRO VARCHAR(255) NOT NULL,
    CIDADE VARCHAR(255) NOT NULL,
    UF CHAR(2) NOT NULL,

    CONSTRAINT PK_LOJAS PRIMARY KEY(ID_LOJA)

    --check da UF?
);
GO

--e se o ESTOQUE dos PRODUTOS fosse por LOJA

CREATE TABLE CARGOS(
    ID_CARGO INT NOT NULL IDENTITY(1,1),
    DESCRICAO VARCHAR(255) NOT NULL,

    CONSTRAINT PK_CARGOS PRIMARY KEY(ID_CARGO)
);
GO

CREATE TABLE FUNCIONARIOS(
    ID_FUNCIONARIO INT NOT NULL, -- IDENTITY(1,1) DEIXEI SEM O IDENTITY PROPOSITALMENTE
    NOME VARCHAR(255) NOT NULL,
    CPF CHAR(11) NOT NULL,
    DT_NASCIMENTO DATE NOT NULL,
    SEXO CHAR(1) NOT NULL,
    TELEFONE CHAR(11) NOT NULL,
    SALARIO NUMERIC(6,2) NOT NULL,
	FK_FUNCIONARIO_CHEFE INT NULL, --POR QUE NÃO -NOT NULL-?
    FK_CARGO INT NOT NULL,

    CONSTRAINT PK_FUNCIONARIOS PRIMARY KEY(ID_FUNCIONARIO),

    CONSTRAINT CHK_FUNCIONARIOS_SEXO CHECK(SEXO IN('M','F')),

    CONSTRAINT CHK_FUNCIONARIOS_SALARIO CHECK(SALARIO > 0),

	CONSTRAINT FK_FUNCIONARIOS_CARGOS FOREIGN KEY(FK_CARGO) REFERENCES CARGOS(ID_CARGO),

	CONSTRAINT FK_FUNCIONARIOS_FUNCIONARIOS FOREIGN KEY(FK_FUNCIONARIO_CHEFE) REFERENCES FUNCIONARIOS(ID_FUNCIONARIO)
);
GO

CREATE TABLE FUNCIONARIOS_VENDEDORES(
	FK_FUNCIONARIO INT NOT NULL,
	TAXA_COMISSAO NUMERIC(4,3),

	CONSTRAINT PK_FUNCIONARIOS_VENDEDORES PRIMARY KEY(FK_FUNCIONARIO),

	CONSTRAINT FK_FUNCIONARIOS_VENDEDORES_FUNCIONARIOS FOREIGN KEY(FK_FUNCIONARIO) REFERENCES FUNCIONARIOS(ID_FUNCIONARIO)
);
GO

CREATE TABLE FUNCIONARIOS_MOTORISTAS(
	FK_FUNCIONARIO INT NOT NULL,
	CNH CHAR(10) NOT NULL,

	CONSTRAINT PK_FUNCIONARIOS_MOTORISTAS PRIMARY KEY(FK_FUNCIONARIO),

	CONSTRAINT FK_FUNCIONARIOS_MOTORISTAS_FUNCIONARIOS FOREIGN KEY(FK_FUNCIONARIO) REFERENCES FUNCIONARIOS(ID_FUNCIONARIO)
);
GO

CREATE TABLE ALOCACOES(
    ID_ALOCACAO INT NOT NULL IDENTITY(1,1),
    FK_FUNCIONARIO INT NOT NULL,
    FK_LOJA INT NOT NULL,
    DT_INICIO DATE NOT NULL DEFAULT GETDATE(),
    DT_FIM DATE NULL,

    CONSTRAINT PK_ALOCACOES PRIMARY KEY(ID_ALOCACAO),

	CONSTRAINT FK_ALOCACOES_FUNCIONARIOS FOREIGN KEY(FK_FUNCIONARIO) REFERENCES FUNCIONARIOS(ID_FUNCIONARIO),

	CONSTRAINT FK_ALOCACOES_LOJAS FOREIGN KEY(FK_LOJA) REFERENCES LOJAS(ID_LOJA)
);
GO

--ALT+F1 / SELECT * FROM SYS.CONSTRAINTS

DROP TABLE ALOCACOES;
GO

CREATE TABLE ALOCACOES(
    ID_ALOCACAO INT NOT NULL IDENTITY(1,1),
    FK_FUNCIONARIO INT NOT NULL,
    FK_LOJA INT NOT NULL,
    DT_INICIO DATE NOT NULL,
    DT_FIM DATE NULL,

    CONSTRAINT PK_ALOCACOES PRIMARY KEY(ID_ALOCACAO),

	CONSTRAINT FK_ALOCACOES_FUNCIONARIOS FOREIGN KEY(FK_FUNCIONARIO) REFERENCES FUNCIONARIOS(ID_FUNCIONARIO),

	CONSTRAINT FK_ALOCACOES_LOJAS FOREIGN KEY(FK_LOJA) REFERENCES LOJAS(ID_LOJA)
);
GO

ALTER TABLE ALOCACOES
ADD CONSTRAINT DEF_ALOCACOES_DT_INICIO DEFAULT GETDATE() FOR DT_INICIO;
GO

CREATE TABLE CLIENTES(
    ID_CLIENTE INT NOT NULL IDENTITY(1,1),
    CPF_CNPJ CHAR(14) NOT NULL,
    TIPO CHAR(2) NOT NULL, --PF/PJ
	LOGRADOURO VARCHAR(255) NULL,
	BAIRRO VARCHAR(255) NULL,
	CEP CHAR(8) NULL,

    CONSTRAINT PK_CLIENTES PRIMARY KEY(ID_CLIENTE),

    CONSTRAINT UNQ_CLIENTES_CPF_CNPJ UNIQUE(CPF_CNPJ)  --COMENTAR A CONSTRAINT
);
GO

CREATE TABLE TELEFONES_CLIENTES(
	ID_TELEFONE_CLIENTE INT NOT NULL IDENTITY(1,1),
	FK_CLIENTE INT NOT NULL,
	TELEFONE CHAR(9) NOT NULL,
	DDD CHAR(2) NOT NULL,

	CONSTRAINT PK_TELEFONES_CLIENTES PRIMARY KEY(ID_TELEFONE_CLIENTE),

	CONSTRAINT FK_TELEFONES_CLIENTES_CLIENTES FOREIGN KEY(FK_CLIENTE) REFERENCES CLIENTES(ID_CLIENTE),

	CONSTRAINT UNQ_TELEFONES_CLIENTES_TELEFONE UNIQUE(FK_CLIENTE,TELEFONE,DDD)
);
GO

CREATE TABLE CLIENTES_PF(
	FK_CLIENTE INT NOT NULL,
    NOME VARCHAR(255) NOT NULL,
	SEXO CHAR(1) NOT NULL,

	CONSTRAINT PK_CLIENTES_PF PRIMARY KEY(FK_CLIENTE),

	CONSTRAINT FK_CLIENTE_PF_CLIENTES FOREIGN KEY(FK_CLIENTE) REFERENCES CLIENTES(ID_CLIENTE),

	CONSTRAINT CHK_CLIENTES_SEXO CHECK(SEXO IN('M','F'))
);
GO

CREATE TABLE CLIENTES_PJ(
	FK_CLIENTE INT NOT NULL,
    RAZAO_SOCIAL VARCHAR(255) NOT NULL,
	NOME_FANTASIA VARCHAR(255) NOT NULL,

	CONSTRAINT PK_CLIENTES_PJ PRIMARY KEY(FK_CLIENTE),

	CONSTRAINT FK_CLIENTE_PJ_CLIENTES FOREIGN KEY(FK_CLIENTE) REFERENCES CLIENTES(ID_CLIENTE)
);
GO


CREATE TABLE VEICULOS(
    ID_VEICULO INT NOT NULL IDENTITY(1,1),
    PLACA CHAR(7) NOT NULL,
    RENAVAM CHAR(11) NOT NULL,
    MODELO VARCHAR(255) NOT NULL,
    ANO_FABRICACAO CHAR(4) NOT NULL,  --OU ALGUM TIPO INTEIRO?

    CONSTRAINT PK_VEICULOS PRIMARY KEY(ID_VEICULO),

	CONSTRAINT UNQ_VEICULOS_RENAVAM UNIQUE(RENAVAM),

	CONSTRAINT UNQ_VEICULOS_PLACA UNIQUE(PLACA)
);
GO

CREATE TABLE ENTREGAS(
    ID_ENTREGA INT NOT NULL IDENTITY(1,1),
    FK_VEICULO INT NOT NULL,
    FK_FUNCIONARIO INT NOT NULL,
    DT_ENTREGA DATE NOT NULL,

    CONSTRAINT PK_ENTREGAS PRIMARY KEY(ID_ENTREGA),

	CONSTRAINT FK_ENTREGAS_VEICULOS FOREIGN KEY(FK_VEICULO) REFERENCES VEICULOS(ID_VEICULO),

	CONSTRAINT FK_ENTREGAS_FUNCIONARIOS_MOTORISTAS FOREIGN KEY(FK_FUNCIONARIO) REFERENCES FUNCIONARIOS_MOTORISTAS(FK_FUNCIONARIO),

	CONSTRAINT UNQ_ENTREGAS_FUNCIONARIO_VEICULO_DATA UNIQUE(FK_VEICULO,FK_FUNCIONARIO,DT_ENTREGA)
);
GO


--FAZER FK PARA CLIENTES USANDO CPF_CNPJ

CREATE TABLE VENDAS(
    ID_VENDA INT NOT NULL IDENTITY(1,1),
    DATA_HORA DATETIME2 NOT NULL,
    FK_ALOCACAO INT NOT NULL,
    FK_CLIENTE INT NOT NULL,
    FK_ENTREGA INT NULL,

    CONSTRAINT PK_VENDAS PRIMARY KEY(ID_VENDA),

	CONSTRAINT FK_VENDAS_ALOCACOES FOREIGN KEY(FK_ALOCACAO) REFERENCES ALOCACOES(ID_ALOCACAO),

    CONSTRAINT FK_VENDAS_ENTREGAS FOREIGN KEY(FK_ENTREGA) REFERENCES ENTREGAS(ID_ENTREGA)
);
GO

ALTER TABLE VENDAS
ADD CPF_CNPJ_CLIENTE CHAR(14) NULL;
GO

ALTER TABLE VENDAS
ADD CONSTRAINT FK_VENDAS_CLIENTES FOREIGN KEY(CPF_CNPJ_CLIENTE) REFERENCES CLIENTES(CPF_CNPJ);
GO

ALTER TABLE VENDAS
DROP CONSTRAINT FK_VENDAS_CLIENTES;
GO

ALTER TABLE VENDAS
DROP COLUMN CPF_CNPJ_CLIENTE;
GO

ALTER TABLE VENDAS
ADD CONSTRAINT FK_VENDAS_CLIENTES FOREIGN KEY(FK_CLIENTE) REFERENCES CLIENTES(ID_CLIENTE);
GO

ALTER TABLE VENDAS
ADD CONSTRAINT DEF_VENDAS_DATA_HORA DEFAULT(GETDATE()) FOR DATA_HORA;
GO

CREATE TABLE ITENS_VENDAS(
    ID_ITEM_VENDA INT NOT NULL IDENTITY(1,1),
    FK_VENDA INT NOT NULL,
    FK_PRODUTO INT NOT NULL,
    VALOR NUMERIC(6,2) NOT NULL,
    QUANTIDADE TINYINT NOT NULL,
    TOTAL_ITEM AS (VALOR * QUANTIDADE),  --EXPLICAR CAMPO CALCULADO

    CONSTRAINT PK_ITENS_VENDAS PRIMARY KEY(ID_ITEM_VENDA),

    CONSTRAINT CHK_ITENS_VENDAS_VALOR CHECK(VALOR > 0),

	CONSTRAINT FK_ITENS_VENDAS_VENDAS FOREIGN KEY(FK_VENDA) REFERENCES VENDAS(ID_VENDA),

	CONSTRAINT FK_ITENS_VENDAS_PRODUTOS FOREIGN KEY(FK_PRODUTO) REFERENCES PRODUTOS(ID_PRODUTO)
);
GO


--GERAR O DER NO SQL SERVER
--CARREGAR O DIAGRAMA (ENGENHARIA REVERSA) COM O MICROSOFT VISIO


--INSERIR DADOS NAS TABELAS
--COMENTAR A ORDEM DE INSERÇÃO DOS DADOS (TABELA PAI x FILHO)


INSERT INTO FABRICANTES(NOME,CNPJ)
VALUES
('FABRICANTE 01','11111111111111');
GO

INSERT INTO FABRICANTES(NOME,CNPJ)
VALUES
('FABRICANTE 02','22222222222222');
GO

INSERT INTO FABRICANTES(NOME,CNPJ)
VALUES
('FABRICANTE 03','33333333333333');
GO


INSERT INTO PRODUTOS(NOME,FK_FABRICANTE)
VALUES
('PRODUTO 01',2),
('PRODUTO 02',3),
('PRODUTO 03',2),
('PRODUTO 04',3),
('PRODUTO 05',2);
GO
select * from PRODUTOS
INSERT INTO PRODUTOS(NOME,FK_FABRICANTE,UNIDADE_MEDIDA)
VALUES
('PRODUTO 01',2,NULL),
('PRODUTO 02',3,'KG'),
('PRODUTO 03',2,'Litros'),
('PRODUTO 04',3,'Gramas'),
('PRODUTO 05',2,'Unidade');
GO

--O QUE ACONTECE? EXPLICAR QUE ESSA QUESTÃO INFLUENCIA A CRIAÇÃO DAS TABELAS TAMBÉM, POIS NÃO POSSO CRIAR UMA TABELA COM FK PARA OUTRA QUE NÃO EXISTE AINDA (SALVO EU CRIE A FK DEPOIS COM ALTER TABLE)
INSERT INTO PRODUTOS(NOME,FK_FABRICANTE)
VALUES
('PRODUTO 06',4);
GO

--EXPLICAR O QUE HOUVE COM A COLUNA IDENTITY
SELECT * FROM PRODUTOS;
GO


INSERT INTO ESTOQUES(FK_PRODUTO,VALOR,QUANTIDADE)
VALUES
(2,20,10),
(3,30,7),
(4,40,5),
(5,50,21),
(6,10,3);
GO

SELECT * FROM ESTOQUES;
GO

INSERT INTO LOJAS(NOME,LOGRADOURO,NUM_LOGRADOURO,CEP,BAIRRO,CIDADE,UF)
VALUES
('LOJA 01','RUA A','1','58000001','BAIRRO A','JOÃO PESSOA','PB'),
('LOJA 02','RUA B','2','58000002','BAIRRO B','NATAL','RN'),
('LOJA 03','RUA C','3','58000003','BAIRRO C','RECIFE','PE');
GO

SELECT * FROM LOJAS;
GO

INSERT INTO CARGOS(DESCRICAO)
VALUES
('MOTORISTA'),
('VENDEDOR'),
('ASG'),
('DIRETOR'),
('CONTADOR');
GO

SELECT * FROM CARGOS;
GO

INSERT INTO FUNCIONARIOS(ID_FUNCIONARIO,NOME,CPF,SEXO,TELEFONE,SALARIO,FK_CARGO, DT_NASCIMENTO,FK_FUNCIONARIO_CHEFE)
VALUES
(1,'FULANO','11111111111','M','911111111',1000,1,'19700101',1); --PODERIA TER FEITO A COLUNA -NOT NULL-?
GO

INSERT INTO FUNCIONARIOS(ID_FUNCIONARIO,NOME,CPF,SEXO,TELEFONE,SALARIO,FK_CARGO, DT_NASCIMENTO,FK_FUNCIONARIO_CHEFE)
VALUES
(2,'BELTRANA','22222222222','F','922222222',2000,3,'19750202',1),
(3,'TRAJANO','33333333333','M','933333333',3000,4,'19800303',1),
(4,'CICRANA','44444444444','F','944444444',4000,5,'19720404',2),
(5,'VENDEDOR 01','55555555555','M','955555555',5000,2,'19820505',3),
(6,'VENDEDORA 02','66666666666','F','966666666',6000,2,'19870606',4),
(7,'VENDEDOR 03','77777777777','M','977777777',7000,2,'19920707',5);
GO

SELECT * FROM FUNCIONARIOS;
GO


INSERT INTO FUNCIONARIOS_MOTORISTAS
(FK_FUNCIONARIO,CNH)
VALUES
(1,'1111111111'),
(2,'2222222222'),
(3,'3333333333'),
(4,'4444444444');
GO

INSERT INTO FUNCIONARIOS_VENDEDORES
(FK_FUNCIONARIO,TAXA_COMISSAO)
VALUES
(5,0.10),
(6,0.25),
(7,0.30);
GO

INSERT INTO ALOCACOES(FK_FUNCIONARIO,FK_LOJA,DT_INICIO,DT_FIM)
VALUES
(1,1,'19900101','19950605'),
(1,2,'19950606',NULL),
(2,2,'20000505',NULL),
(3,3,'19990101',NULL),
(4,1,'20010303',NULL),
(5,2,'20020404',NULL),
(6,3,'20020505',NULL),
(7,1,'20060707',NULL);
GO

SELECT * FROM ALOCACOES;
GO

--QUAL O PROBLEMA?
INSERT INTO CLIENTES(CPF_CNPJ,TIPO)
VALUES
('77777777777','PF'),
('66666666666666','PJ'),
('88888888888','PF'),
('666666666666','PJ'),
('99999999999','PF');
GO
select * from CLIENTES

--COMENTAR A VANTAGEM QUE HÁ EM SER POSSÍVEL VER O NOME DA CONSTRAINT
ALTER TABLE CLIENTES DROP CONSTRAINT UNQ_CLIENTES_CPF_CNPJ;
GO

DBCC CHECKIDENT ('DBO.CLIENTES', RESEED, 1);  
GO  

INSERT INTO CLIENTES(CPF_CNPJ,TIPO)
VALUES
('77777777777','PF'),
('66666666666666','PJ'),
('88888888888','PF'),
('66666666666666','PJ'),
('99999999999','PF');
GO

SELECT * FROM CLIENTES;
GO

TRUNCATE TABLE CLIENTES;
GO

DELETE FROM CLIENTES;
GO

SELECT * FROM CLIENTES;
GO

DBCC CHECKIDENT ('DBO.CLIENTES', RESEED, 0);
GO  

INSERT INTO CLIENTES(CPF_CNPJ,TIPO)
VALUES
('77777777777','PF'),
('66666666666666','PJ'),
('88888888888','PF'),
('55555555555555','PJ'),
('99999999999','PF');
GO

SELECT * FROM CLIENTES;
GO


INSERT INTO CLIENTES_PF
(FK_CLIENTE,NOME,SEXO)
VALUES
(1,'CLIENTE 01','M'),
(3,'CLIENTE 03','F'),
(5,'CLIENTE 05','M');
GO

SELECT * FROM CLIENTES_PF;
GO

INSERT INTO CLIENTES_PJ
(FK_CLIENTE,RAZAO_SOCIAL,NOME_FANTASIA)
VALUES
(2,'CLIENTE 02','FANTASIA 02'),
(4,'CLIENTE 04','FANTASIA 04');
GO

SELECT * FROM CLIENTES_PJ;
GO

INSERT INTO VENDAS(DATA_HORA,FK_ALOCACAO,FK_CLIENTE)
VALUES
(DEFAULT,6,1),
(NULL,7,2),
('20190914',8,3),
(DEFAULT,6,4),
(NULL,7,5),
('20190914',8,1),
(DEFAULT,6,2),
(NULL,7,3),
('20190914',8,2);
GO

DBCC CHECKIDENT ('DBO.VENDAS', RESEED, 0);
GO

--O QUE HOUVE?
INSERT INTO VENDAS(DATA_HORA,FK_ALOCACAO,FK_CLIENTE)
VALUES
(DEFAULT,6,1),
('20190913',7,2),
('20190914',8,3),
(DEFAULT,6,4),
('20190913',7,5),
('20190914',8,1),
(DEFAULT,6,2),
('20190913',7,3),
('20190914',8,2);
GO

SELECT * FROM VENDAS;
GO

INSERT INTO ITENS_VENDAS(FK_VENDA,FK_PRODUTO,VALOR,QUANTIDADE)
VALUES
(1,2,31,1),
(1,5,73,2),
(2,3,84,3),
(2,4,8,4),
(2,6,32,5),
(3,5,34,7),
(3,5,33,2),
(4,6,72,9),
(4,4,47,5),
(5,3,25,3),
(6,2,6,4),
(6,5,9,3),
(6,3,21,3),
(6,5,12,8),
(7,4,11,6),
(7,4,73,5),
(8,6,46,3),
(8,3,34,7),
(8,5,22,3),
(9,2,11,2),
(9,6,29,1);
GO

SELECT * FROM ITENS_VENDAS;  --COMENTAR O CAMPO CALCULADO
GO

INSERT INTO VEICULOS(PLACA,RENAVAM,MODELO,ANO_FABRICACAO)
VALUES
('AAA1111','01234567890','KOMBI','2016'),
('BBB2222','12345678901','F1000','2017'),
('CCC3333','23456789012','TORO','2018'),
('DDD4444','34567890123','F250','2019'),
('EEE5555','45678901234','L200','2019');
GO

SELECT * FROM VEICULOS;
GO

INSERT INTO ENTREGAS(FK_VEICULO,FK_FUNCIONARIO,DT_ENTREGA)
VALUES
(1,1,'20190101'),
(2,2,'20190202'),
(3,1,'20190303'),
(4,2,'20190404'),
(5,1,'20190505'),
(5,3,'20190606');
GO

SELECT * FROM ENTREGAS;
GO

INSERT INTO TELEFONES_CLIENTES
(FK_CLIENTE,TELEFONE,DDD)
VALUES
(1,'11111111','83'),
(2,'22222222','83'),
(2,'22222222','84'),
(3,'33333333','83'),
(4,'44444444','83'),
(5,'55555555','81'),
(5,'55555555','83');
GO

--UPDATE
UPDATE [FUNCIONARIOS]
SET SALARIO = SALARIO + 100;
GO

SELECT * FROM FUNCIONARIOS;
GO

UPDATE [FUNCIONARIOS]
SET 
	SALARIO = SALARIO + 100,
	NOME = NOME + ' SUFIXO';
GO

SELECT * FROM FUNCIONARIOS;
GO

--O QUE HOUVE?
UPDATE FUNCIONARIOS
SET ID_FUNCIONARIO = 8;
GO

SELECT * FROM FUNCIONARIOS;
GO

--DELETE + FK

DELETE FROM FUNCIONARIOS;
GO

TRUNCATE TABLE FUNCIONARIOS;
GO


--CLAUSULA WHERE
SELECT * FROM FUNCIONARIOS;
GO

SELECT * FROM FUNCIONARIOS
WHERE SALARIO < 3000;
GO

UPDATE [FUNCIONARIOS]
SET SALARIO = SALARIO + 100
WHERE SALARIO < 3000;
GO

SELECT * FROM FUNCIONARIOS;
GO

SELECT * FROM FUNCIONARIOS
WHERE SALARIO < 3000;
GO

DELETE FROM FUNCIONARIOS
WHERE ID_FUNCIONARIO = 1;
GO

SELECT * FROM FUNCIONARIOS;
GO

--COMENTAR O USO DOS OPERADORES: =, >=, <=, >, <, <> (!=)



--Explicar a parte de ON UPDATE/ON DELETE das FKs

ALTER TABLE ENTREGAS
ADD CONSTRAINT FK_ENTREGAS_FUNCIONARIOS FOREIGN KEY(FK_FUNCIONARIO) REFERENCES FUNCIONARIOS(ID_FUNCIONARIO)
ON UPDATE {NO ACTION | CASCADE | SET NULL | SET DEFAULT}
ON DELETE {NO ACTION | CASCADE | SET NULL | SET DEFAULT};
GO

SELECT * FROM ENTREGAS;
GO

---NO ACTION

UPDATE FUNCIONARIOS
SET ID_FUNCIONARIO = 10
WHERE ID_FUNCIONARIO = 1;
GO

SELECT * FROM FUNCIONARIOS_MOTORISTAS;
GO

DELETE FROM FUNCIONARIOS
WHERE ID_FUNCIONARIO = 2;
GO

SELECT * FROM FUNCIONARIOS_MOTORISTAS;
GO

---CASCADE
ALTER TABLE FUNCIONARIOS_MOTORISTAS
DROP CONSTRAINT FK_FUNCIONARIOS_MOTORISTAS_FUNCIONARIOS;
GO

ALTER TABLE FUNCIONARIOS_MOTORISTAS
ADD CONSTRAINT FK_FUNCIONARIOS_MOTORISTAS_FUNCIONARIOS FOREIGN KEY(FK_FUNCIONARIO) REFERENCES FUNCIONARIOS(ID_FUNCIONARIO)
ON UPDATE CASCADE
ON DELETE CASCADE;
GO

SELECT * FROM FUNCIONARIOS_MOTORISTAS;
GO

--EVITAR EFEITO CICLICO
ALTER TABLE [FUNCIONARIOS] DROP CONSTRAINT [FK_FUNCIONARIOS_FUNCIONARIOS]
GO

ALTER TABLE [dbo].[FUNCIONARIOS]  
ADD CONSTRAINT [FK_FUNCIONARIOS_FUNCIONARIOS] 
FOREIGN KEY([FK_FUNCIONARIO_CHEFE]) REFERENCES [dbo].[FUNCIONARIOS] ([ID_FUNCIONARIO])
ON UPDATE CASCADE ON DELETE CASCADE
GO


UPDATE FUNCIONARIOS
SET ID_FUNCIONARIO = 10
WHERE ID_FUNCIONARIO = 1;
GO

ALTER TABLE ALOCACOES DROP CONSTRAINT FK_ALOCACOES_FUNCIONARIOS;
GO

ALTER TABLE ENTREGAS DROP CONSTRAINT FK_ENTREGAS_FUNCIONARIOS_MOTORISTAS;
GO

UPDATE FUNCIONARIOS
SET ID_FUNCIONARIO = 10
WHERE ID_FUNCIONARIO = 1;
GO

SELECT * FROM FUNCIONARIOS;
GO
SELECT * FROM ENTREGAS;
GO

SELECT * FROM FUNCIONARIOS_MOTORISTAS;
GO


DELETE FROM FUNCIONARIOS
WHERE ID_FUNCIONARIO = 10;
GO

SELECT * FROM FUNCIONARIOS;
GO
SELECT * FROM ENTREGAS;
GO

SELECT * FROM FUNCIONARIOS_MOTORISTAS;
GO

---SET NULL
--ALTERAR A COLUNA FK_FUNCIONARIO PARA QUE PASSE A ACEITAR VALORES NULL
ALTER TABLE ENTREGAS
ALTER COLUMN FK_FUNCIONARIO INT NULL;
GO

--POSSO RECRIAR?
ALTER TABLE ENTREGAS
ADD CONSTRAINT FK_ENTREGAS_FUNCIONARIOS FOREIGN KEY(FK_FUNCIONARIO) REFERENCES FUNCIONARIOS(ID_FUNCIONARIO)
ON UPDATE SET NULL
ON DELETE SET NULL;
GO

SELECT * FROM ENTREGAS;
GO

--CORRIGINDO OS DADOS
UPDATE ENTREGAS
SET FK_FUNCIONARIO = 3
WHERE FK_FUNCIONARIO = 1;
GO

SELECT * FROM ENTREGAS;
GO

--E AGORA?
ALTER TABLE ENTREGAS
ADD CONSTRAINT FK_ENTREGAS_FUNCIONARIOS FOREIGN KEY(FK_FUNCIONARIO) REFERENCES FUNCIONARIOS(ID_FUNCIONARIO)
ON UPDATE SET NULL
ON DELETE SET NULL;
GO


UPDATE FUNCIONARIOS
SET ID_FUNCIONARIO = 11
WHERE ID_FUNCIONARIO = 2;
GO

SELECT * FROM ENTREGAS;
GO


---SET DEFAULT
ALTER TABLE ENTREGAS
DROP CONSTRAINT FK_ENTREGAS_FUNCIONARIOS;
GO

ALTER TABLE ENTREGAS
ADD CONSTRAINT FK_ENTREGAS_FUNCIONARIOS FOREIGN KEY(FK_FUNCIONARIO) REFERENCES FUNCIONARIOS(ID_FUNCIONARIO)
ON UPDATE SET DEFAULT
ON DELETE SET DEFAULT;
GO

ALTER TABLE ENTREGAS
ADD CONSTRAINT DEF_ENTREGAS_FK_FUNCIONARIO DEFAULT 4 FOR FK_FUNCIONARIO;
GO

SELECT * FROM ENTREGAS;
GO

DELETE FROM FUNCIONARIOS
WHERE ID_FUNCIONARIO = 3;
GO

SELECT * FROM ENTREGAS;
GO



----NOVAMENTE ALTER TABLE

--O QUE ACONTECE?
SELECT * FROM PRODUTOS;
GO


ALTER TABLE PRODUTOS
ALTER COLUMN UNIDADE_MEDIDA VARCHAR(4) NULL;
GO

ALTER TABLE PRODUTOS
ALTER COLUMN UNIDADE_MEDIDA VARCHAR(8) NULL;
GO


ALTER TABLE PRODUTOS
ALTER COLUMN UNIDADE_MEDIDA VARCHAR(8) NOT NULL;
GO

UPDATE PRODUTOS
SET UNIDADE_MEDIDA = 'KG'
WHERE UNIDADE_MEDIDA IS NULL;  --EXPLICAR O TRATAMENTO DE NULOS
GO

SELECT * FROM PRODUTOS;
GO

ALTER TABLE PRODUTOS
ALTER COLUMN UNIDADE_MEDIDA VARCHAR(8) NOT NULL;
GO




SELECT * FROM VENDAS;
GO

UPDATE VENDAS
SET FK_ENTREGA = (ID_VENDA % 6) + 1;
GO

SELECT * FROM VENDAS;
GO